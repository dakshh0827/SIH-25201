/*
 * =====================================================
 * 1. backend/prisma/schema.prisma (UPDATED)
 * =====================================================
 */
// This is your Prisma schema file
// Database: MongoDB

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = "mongodb+srv://dakshthakran05_db_user:XNuoDz8HxynA0iYG@cluster0.9awo5nj.mongodb.net/SIH_Finals?appName=Cluster0"
}

// ==================== INSTITUTE MODEL (NEW) ====================
model Institute {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  instituteId String   @unique // NEW: Human-readable public ID
  name        String   @unique
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  labs  Lab[]
  users User[]

  @@map("institutes")
}

// ==================== USER MODEL (UPDATED) ====================
model User {
  id            String       @id @default(auto()) @map("_id") @db.ObjectId
  email         String       @unique
  password      String?
  firstName     String
  lastName      String
  role          UserRole     @default(TRAINER)
  phone         String?
  // --- UPDATED: These fields are now used by both Trainer and Lab Manager ---
  department    Department? // Department for Trainer & Lab Manager
  instituteId   String? // Institute for Trainer & Lab Manager
  institute     Institute? @relation(fields: [instituteId], references: [instituteId], onDelete: SetNull)
  labId         String? @db.ObjectId // Primary lab for Trainer & Lab Manager
  lab           Lab? @relation(fields: [labId], references: [id], onDelete: SetNull)
  // --- END UPDATE ---
  
  isActive      Boolean      @default(true)
  emailVerified Boolean      @default(false)
  
  // --- FIX: ADDED MISSING AUTH FIELDS ---
  authProvider  AuthProvider @default(CREDENTIAL)
  googleId      String?      @unique
  githubId      String?      @unique
  // --- END FIX ---
  
  // ADDED: Missing reverse relations
  notifications      Notification[]    // Reverse relation for Notification.user
  maintenanceLogs    MaintenanceLog[]  // Reverse relation for MaintenanceLog.technician
  reports            Report[]          // Reverse relation for Report.user
  chatMessages       ChatMessage[]     // Reverse relation for ChatMessage.user
  
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  @@index([instituteId])
  @@index([department])
  @@index([labId])
  @@map("users")
}

// ==================== LAB MODEL (UPDATED) ====================
model Lab {
  id         String     @id @default(auto()) @map("_id") @db.ObjectId
  labId      String     @unique
  name       String
  
  // --- UPDATED: Relation now uses the string 'instituteId' ---
  instituteId String    // This will store the public instituteId string
  institute   Institute @relation(fields: [instituteId], references: [instituteId], onDelete: Restrict)
  
  department Department
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt

  // Relations
  equipments Equipment[]
  trainers   User[]

  @@index([instituteId]) // UPDATED
  @@map("labs")
}

// (Rest of schema.prisma: OTP, Enums, Equipment, Analytics, etc. remains the same)
// ... (omitted for brevity) ...

// ==================== OTP MODEL ====================
model OTP {
  id        String     @id @default(auto()) @map("_id") @db.ObjectId
  email     String
  otp       String
  purpose   OTPPurpose
  isUsed    Boolean    @default(false)
  expiresAt DateTime
  createdAt DateTime   @default(now())

  @@index([email, purpose])
  @@index([expiresAt])
  @@map("otps")
}

// ==================== ENUMS ====================
enum AuthProvider {
  CREDENTIAL
  GOOGLE
  GITHUB
}

enum OTPPurpose {
  REGISTRATION
  LOGIN
}

enum UserRole {
  POLICY_MAKER   // Can manage labs, view all data across institutes
  LAB_MANAGER    // Manages equipment in specific department/institute, cannot create/delete labs
  TRAINER        // Views equipment in their specific lab
}

// ==================== DEPARTMENT ENUM (9 Departments) ====================
enum Department {
  FITTER_MANUFACTURING
  ELECTRICAL_ENGINEERING
  WELDING_FABRICATION
  TOOL_DIE_MAKING
  ADDITIVE_MANUFACTURING
  SOLAR_INSTALLER_PV
  MATERIAL_TESTING_QUALITY
  ADVANCED_MANUFACTURING_CNC
  AUTOMOTIVE_MECHANIC
}

// ==================== EQUIPMENT ENUMS BY DEPARTMENT ====================

// Fitter/Manufacturing Equipment
enum FitterEquipmentName {
  BENCH_DRILLING_MACHINE
  ANGLE_GRINDER_PORTABLE
  MANUAL_ARC_WELDING_MACHINE
  GAS_WELDING_KIT
  MIG_CO2_WELDING_MACHINE
}

// Electrical Engineering Equipment
enum ElectricalEquipmentName {
  ELECTRICIAN_TRAINING_PANEL
  ADVANCED_ELECTRICIAN_SETUP_PLC_VFD
  BENCH_DRILLING_MACHINE
}

// Welding & Fabrication Equipment
enum WeldingEquipmentName {
  ARC_WELDING_MACHINE_200_300A
  GAS_WELDING_KIT_OXY_ACETYLENE
  MIG_CO2_WELDING_MACHINE_250_400A
  VR_AR_WELDING_SIMULATOR
}

// Tool & Die Making Equipment
enum ToolDieEquipmentName {
  TOOL_DIE_EQUIPMENT_EDM_JIG_BORING
  PLANER_MACHINE
  GEAR_HOBBING_SHAPING_MACHINE
}

// Additive Manufacturing Equipment
enum AdditiveManufacturingEquipmentName {
  THREE_D_PRINTER_FDM_RESIN
  LASER_ENGRAVING_CUTTING_MACHINE
}

// Solar Installer (PV) Equipment
enum SolarInstallerEquipmentName {
  INVERTER_TRAINING_UNIT
  DRILLING_MACHINE_AND_TOOLS
}

// Material Testing / Quality Equipment
enum MaterialTestingEquipmentName {
  TENSILE_TESTING_MACHINE
  COMPRESSION_TESTING_MACHINE
  IMPACT_TESTING_MACHINE_CHARPY_IZOD
  HARDNESS_TESTER_ROCKWELL_BRINELL_VICKERS
  OPTICAL_COMPARATOR
  ENVIRONMENTAL_CHAMBER
}

// Advanced Manufacturing/CNC Equipment
enum AdvancedManufacturingEquipmentName {
  CNC_VERTICAL_MACHINING_CENTER_3_4_AXIS
  CNC_LATHE_2_AXIS
}

// Automotive/Mechanic Equipment
enum AutomotiveEquipmentName {
  MOTOR_VEHICLE_TRAINING_MODEL
}

// ==================== EQUIPMENT MODEL ====================
model Equipment {
  id             String     @id @default(auto()) @map("_id") @db.ObjectId
  equipmentId    String     @unique // Public equipment ID
  name           String
  department     Department
  labId          String     @db.ObjectId
  lab            Lab        @relation(fields: [labId], references: [id], onDelete: Restrict)
  manufacturer   String
  model          String
  serialNumber   String?
  purchaseDate   DateTime
  warrantyExpiry DateTime?
  specifications Json?
  imageUrl       String?
  isActive       Boolean    @default(true)
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt

  // Department-specific equipment names
  fitterEquipmentName               FitterEquipmentName?
  electricalEquipmentName           ElectricalEquipmentName?
  weldingEquipmentName              WeldingEquipmentName?
  toolDieEquipmentName              ToolDieEquipmentName?
  additiveManufacturingEquipmentName AdditiveManufacturingEquipmentName?
  solarInstallerEquipmentName       SolarInstallerEquipmentName?
  materialTestingEquipmentName      MaterialTestingEquipmentName?
  advancedManufacturingEquipmentName AdvancedManufacturingEquipmentName?
  automotiveEquipmentName           AutomotiveEquipmentName?
  // Relations
  status          EquipmentStatus?
  sensorData      SensorData[]
  alerts          Alert[]
  maintenanceLogs MaintenanceLog[]
  usageAnalytics  UsageAnalytics[]
  analyticsParams DepartmentAnalytics?
  @@index([labId])
  @@index([department])
  @@map("equipment")
}

// ==================== DEPARTMENT-SPECIFIC ANALYTICS ====================
model DepartmentAnalytics {
  id          String     @id @default(auto()) @map("_id") @db.ObjectId
  equipmentId String     @unique @db.ObjectId
  equipment   Equipment  @relation(fields: [equipmentId], references: [id], onDelete: Cascade)
  department  Department

  // Common parameters across all departments
  temperature       Float? // Current temperature
  efficiency        Float? // Efficiency percentage
  totalUptime       Float  @default(0) // Total uptime in hours
  totalDowntime     Float  @default(0) // Total downtime in hours
  utilizationRate   Float  @default(0) // Percentage
  
  // Department-specific parameters (nullable based on department)
  // Fitter/Manufacturing & Welding
  vibration         Float?
  arcStability      Float? // For welding
  weldQuality       Float? // For welding
  
  // Electrical Engineering
  voltage           Float?
  current           Float?
  powerFactor       Float?
  // Material Testing
  testAccuracy      Float?
  calibrationStatus String?
  loadCapacity      Float?
  // Advanced Manufacturing/CNC
  spindleSpeed      Float?
  feedRate          Float?
  toolWear          Float?
  dimensionalAccuracy Float?
  // Additive Manufacturing
  printQuality      Float?
  layerHeight       Float?
  materialUsage     Float?
  
  // Solar Installer
  solarEfficiency   Float?
  powerOutput       Float?
  batteryHealth     Float?
  
  // Automotive
  enginePerformance Float?
  fuelEfficiency    Float?
  
  // Tool & Die Making
  precisionLevel    Float?
  surfaceFinish     Float?
  
  updatedAt DateTime @updatedAt

  @@map("department_analytics")
}

// ==================== EQUIPMENT STATUS ====================
model EquipmentStatus {
  id                  String            @id @default(auto()) @map("_id") @db.ObjectId
  equipmentId         String            @unique @db.ObjectId
  equipment           Equipment         @relation(fields: [equipmentId], references: [id], onDelete: Cascade)
  status              OperationalStatus @default(IDLE)
  healthScore         Float             @default(100)
  isOperatingInClass  Boolean           @default(false) // NEW: Tracks if equipment is being used in class
  currentOperator     String?
  lastMaintenanceDate DateTime?
  nextMaintenanceDate DateTime?
  lastUsedAt          DateTime?
  updatedAt           DateTime          @updatedAt

  @@map("equipment_status")
}

enum OperationalStatus {
  OPERATIONAL
  IN_USE
  IN_CLASS     // NEW: Equipment being used during class
  IDLE
  MAINTENANCE
  FAULTY
  OFFLINE
  WARNING
}

// ==================== SENSOR DATA ====================
model SensorData {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  equipmentId String    @db.ObjectId
  equipment   Equipment @relation(fields: [equipmentId], references: [id], onDelete: Cascade)
  timestamp   DateTime  @default(now())
  
  // Generic sensor data
  temperature       Float?
  vibration         Float?
  energyConsumption Float?
  pressure          Float?
  humidity          Float?
  // Department-specific sensor data
  voltage           Float?
  current           Float?
  rpm               Float?
  powerFactor       Float?
  loadForce         Float?
  isAnomaly    Boolean @default(false)
  anomalyScore Float?

  @@map("sensor_data")
  @@index([equipmentId, timestamp(sort: Desc)])
}

// ==================== ALERTS ====================
model Alert {
  id            String        @id @default(auto()) @map("_id") @db.ObjectId
  equipmentId   String        @db.ObjectId
  equipment     Equipment     @relation(fields: [equipmentId], references: [id], onDelete: Cascade)
  type          AlertType
  severity      AlertSeverity
  title         String
  message       String
  isResolved    Boolean       @default(false)
  resolvedAt    DateTime?
  resolvedBy    String?
  createdAt     DateTime      @default(now())
  notifications Notification[]

  @@map("alerts")
  @@index([equipmentId, createdAt(sort: Desc)])
}

enum AlertType {
  FAULT_DETECTED
  HIGH_TEMPERATURE
  ABNORMAL_VIBRATION
  HIGH_ENERGY_CONSUMPTION
  MAINTENANCE_DUE
  WARRANTY_EXPIRING
  UNSAFE_USAGE
  UNSAFE_PATTERN_DETECTED // NEW: For unsafe patterns during class
  EQUIPMENT_OFFLINE
  LOW_HEALTH_SCORE
  CUSTOM
}

enum AlertSeverity {
  CRITICAL
  HIGH
  MEDIUM
  LOW
}

// ==================== NOTIFICATIONS ====================
model Notification {
  id        String           @id @default(auto()) @map("_id") @db.ObjectId
  userId    String           @db.ObjectId
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  alertId   String?          @db.ObjectId
  alert     Alert?           @relation(fields: [alertId], references: [id], onDelete: Cascade)
  title     String
  message   String
  type      NotificationType
  isRead    Boolean          @default(false)
  createdAt DateTime         @default(now())

  @@map("notifications")
  @@index([userId, createdAt(sort: Desc)])
}

enum NotificationType {
  ALERT
  MAINTENANCE
  REPORT
  SYSTEM
  CHAT
  UNSAFE_PATTERN // NEW: For unsafe usage alerts
}

// ==================== MAINTENANCE LOGS ====================
model MaintenanceLog {
  id            String            @id @default(auto()) @map("_id") @db.ObjectId
  equipmentId   String            @db.ObjectId
  equipment     Equipment         @relation(fields: [equipmentId], references: [id], onDelete: Cascade)
  type          MaintenanceType
  status        MaintenanceStatus @default(SCHEDULED)
  scheduledDate DateTime
  completedDate DateTime?
  description   String
  notes         String?
  cost          Float?
  technicianId  String            @db.ObjectId
  technician    User              @relation(fields: [technicianId], references: [id])
  partsReplaced Json?
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  @@map("maintenance_logs")
  @@index([equipmentId, scheduledDate(sort: Desc)])
}

enum MaintenanceType {
  PREVENTIVE
  PREDICTIVE
  CORRECTIVE
  EMERGENCY
  ROUTINE
}

enum MaintenanceStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  OVERDUE
}

// ==================== USAGE ANALYTICS ====================
model UsageAnalytics {
  id              String    @id @default(auto()) @map("_id") @db.ObjectId
  equipmentId     String    @db.ObjectId
  equipment       Equipment @relation(fields: [equipmentId], references: [id], onDelete: Cascade)
  date            DateTime
  totalUsageHours Float     @default(0) // Total uptime
  totalDowntime   Float     @default(0) // Total downtime
  utilizationRate Float     @default(0) // Percentage
  efficiency      Float     @default(0)
  sessionsCount   Int       @default(0) // Number of times equipment was used
  classSessions   Int       @default(0) // NEW: Number of class sessions
  avgSessionTime  Float     @default(0)
  energyConsumed  Float     @default(0)
  createdAt       DateTime  @default(now())

  @@map("usage_analytics")
  @@unique([equipmentId, date])
  @@index([equipmentId, date(sort: Desc)])
}

// ==================== REPORTS ====================
model Report {
  id          String     @id @default(auto()) @map("_id") @db.ObjectId
  reportType  ReportType
  title       String
  dateFrom    DateTime
  dateTo      DateTime
  generatedBy String     @db.ObjectId
  user        User       @relation(fields: [generatedBy], references: [id])
  data        Json
  fileUrl     String?
  createdAt   DateTime   @default(now())

  @@map("reports")
  @@index([generatedBy, createdAt(sort: Desc)])
}

enum ReportType {
  DAILY_SUMMARY
  WEEKLY_SUMMARY
  MONTHLY_SUMMARY
  EQUIPMENT_HEALTH
  MAINTENANCE_HISTORY
  USAGE_ANALYTICS
  ALERT_HISTORY
  ENERGY_CONSUMPTION
  DEPARTMENT_SUMMARY  // NEW: Summary by department
  LIFECYCLE_REPORT    // NEW: Equipment lifecycle analysis
  CUSTOM
}

// ==================== CHATBOT ====================
model ChatMessage {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  message   String
  response  String?
  intent    String?
  createdAt DateTime @default(now())

  @@map("chat_messages")
  @@index([userId, createdAt(sort: Desc)])
}

// ==================== SYSTEM CONFIG ====================
model SystemConfig {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  key         String   @unique
  value       Json
  description String?
  updatedAt   DateTime @updatedAt

  @@map("system_config")
}